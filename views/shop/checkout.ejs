<%- include('../partials/header') %>
<%- include("../partials/navbar") %>

<h2 style="text-align:center;margin-top:30px;">Checkout</h2>

<div style="max-width:500px;margin:auto;padding:20px;">

<form action="/checkout/calculate" method="POST" id="checkoutForm">

    <!-- Name -->
    <label>Name</label>
    <input type="text" name="customer_name" required style="padding:8px;width:100%">

    <!-- Phone -->
    <label style="margin-top:10px;">Phone</label>
    <input type="text" name="customer_phone" required style="padding:8px;width:100%">

    <!-- Address (Only if GPS Off) -->
    <label style="margin-top:10px;">Delivery Address (If GPS Off)</label>
    <textarea name="customer_address" style="padding:8px;width:100%;height:70px;"></textarea>

    <!-- Delivery Method -->
    <label style="margin-top:10px;">Delivery Method</label>
    <select name="delivery_method" required style="padding:8px;width:100%">
        <option value="pathao">Pathao</option>
        <option value="indrive">InDrive</option>
        <option value="yango">Yango</option>
    </select>

    <!-- Location Source -->
    <label style="margin-top:10px;">Location Source</label>
    <select name="location_source" id="locationSource" style="padding:8px;width:100%">
        <option value="gps" selected>üìç GPS (Recommended)</option>
        <option value="address">Manual Address</option>
    </select>

    <!-- GPS Box -->
    <div id="gpsBox" style="
        margin-top:10px;
        padding:10px;
        background:#e7f3ff;
        border-radius:6px;
    ">
        <b>Status:</b> 
        <span id="gpsStatus" style="color:orange;">Waiting...</span><br>

        <button type="button" id="getLocationBtn"
            style="margin-top:8px;background:#007bff;color:white;padding:6px 12px;border:none;border-radius:4px;">
            Detect My Location
        </button>
    </div>

    <!-- Hidden Coordinates -->
    <input type="hidden" name="lat" id="lat">
    <input type="hidden" name="lng" id="lng">

    <!-- Total -->
    <h3 style="margin-top:20px;">Total: Rs <%= total %></h3>

    <!-- Submit -->
    <button type="submit"
        style="background:black;color:white;padding:10px;border:none;border-radius:5px;width:100%;margin-top:10px;">
        Continue
    </button>

</form>
</div>

<script>
// Detect Location
document.getElementById("getLocationBtn").onclick = () => {
    navigator.geolocation.getCurrentPosition(pos => {
        lat.value = pos.coords.latitude;
        lng.value = pos.coords.longitude;
        gpsStatus.innerHTML = "<span style='color:green;'>Captured ‚úî</span>";
    }, () => alert("Enable GPS to continue"));
};

// Toggle GPS Box depending on selection
const locationSource = document.getElementById("locationSource");
const gpsBox = document.getElementById("gpsBox");

locationSource.onchange = () => {
    if (locationSource.value === "gps") {
        gpsBox.style.display = "block";
    } else {
        gpsBox.style.display = "none";
        lat.value = "";
        lng.value = "";
    }
};

// Form Validation on Submit
document.getElementById("checkoutForm").addEventListener("submit", (e) => {
    if (locationSource.value === "gps" && (!lat.value || !lng.value)) {
        e.preventDefault();
        alert("Click Detect My Location first!");
    }
});
</script>

<%- include('../partials/footer') %>
