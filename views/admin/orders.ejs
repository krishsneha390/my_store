<%- include('../partials/header') %>

<h2 style="text-align:center;margin:30px 0;font-size:28px;">Orders</h2>

<table border="1" width="95%" style="margin:auto;border-collapse:collapse;font-size:15px;">
    <tr style="background:#f1f1f1;font-weight:bold;text-align:center;">
        <td>ID</td>
        <td>Name</td>
        <td>Phone</td>
        <td>Address</td>
        <td>Distance</td>
        <td>Delivery Fee</td>
        <td>Location</td>
        <td>Total</td>
        <td>Items</td>
        <td>Date</td>
        <td>Action</td>
    </tr>

    <% orders.forEach(order => { 
        const items = typeof order.items === "string" ? JSON.parse(order.items) : order.items;
    %>

    <tr style="text-align:center;">
        <td><%= order.id %></td>
        <td><%= order.customer_name %></td>
        <td><%= order.customer_phone %></td>
        <td><%= order.customer_address || "N/A" %></td>

        <!-- Delivery Distance -->
        <td><%= order.delivery_distance ? order.delivery_distance + " km" : "N/A" %></td>

        <!-- Delivery Fee -->
        <td>Rs <%= order.delivery_fee || 0 %></td>

        <!-- Google Map Location -->
        <td>
            <% if(order.delivery_lat && order.delivery_lng){ %>
                <a href="https://www.google.com/maps?q=<%= order.delivery_lat %>,<%= order.delivery_lng %>"
                   target="_blank"
                   style="background:#007bff;color:#fff;padding:6px 12px;border-radius:5px;text-decoration:none;display:inline-block;">
                    üìç View Map
                </a>
            <% } else { %>
                <span style="color:#888;">No GPS</span>
            <% } %>
        </td>

        <!-- Total -->
        <td>Rs <%= order.total %></td>

        <!-- Items (open modal) -->
        <td>
            <button onclick="openModal(<%= order.id %>)"
                style="background:#28a745;color:white;padding:6px 10px;border:none;border-radius:5px;cursor:pointer;">
                View (<%= items.length %>)
            </button>

            <!-- Hidden modal content -->
            <div id="modal-data-<%= order.id %>" style="display:none;">
                <h2 style="margin-bottom:10px;">Order #<%= order.id %> Items</h2>

                <% items.forEach(i => { %>
                    <div style="border-bottom:1px solid #ddd;padding:10px 0;">
                        <b><%= i.name %></b><br>
                        Qty: <%= i.qty %><br>
                        Price: Rs <%= i.price %><br>
                        Subtotal: Rs <%= i.qty * i.price %>
                    </div>
                <% }) %>
            </div>
        </td>

        <!-- Date -->
        <td><%= new Date(order.created_at).toDateString() %></td>

        <!-- Delete -->
        <td>
            <form action="/admin/orders/delete/<%= order.id %>" method="POST" style="display:inline;">
                <button style="background:red;color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;">
                    Delete
                </button>
            </form>
        </td>
    </tr>

    <% }) %>
</table>

<!-- üåü MODAL UI -->
<style>
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 999;
}

.modal-box {
    width: 450px;
    max-height: 80vh;
    background: white;
    padding: 25px;
    border-radius: 10px;
    overflow-y: auto;
    box-shadow: 0 0 20px rgba(0,0,0,0.4);
    animation: showModal 0.25s ease-out;
}

@keyframes showModal {
    from { transform: scale(0.8); opacity: 0; }
    to   { transform: scale(1); opacity: 1; }
}

.close-btn {
    background: red;
    color: white;
    border: none;
    padding: 6px 12px;
    float: right;
    border-radius: 5px;
    cursor: pointer;
}
</style>

<!-- Modal Structure -->
<div id="modal-overlay" class="modal-overlay">
    <div class="modal-box">
        <button class="close-btn" onclick="closeModal()">Close</button>
        <div id="modal-content" style="margin-top:20px;"></div>
    </div>
</div>

<!-- Modal Script -->
<script>
function openModal(id) {
    const content = document.getElementById("modal-data-" + id).innerHTML;

    document.getElementById("modal-content").innerHTML = content;
    document.getElementById("modal-overlay").style.display = "flex";
}

function closeModal() {
    document.getElementById("modal-overlay").style.display = "none";
}
</script>

<%- include('../partials/footer') %>
